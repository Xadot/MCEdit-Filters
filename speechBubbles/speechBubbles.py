#### Speech Bubbles ####
# Filter for MCEdit by jgierer12, idea by SimplySarc

from pymclevel.schematic import MCSchematic
import mcplatform

from pymclevel import TAG_Int
from pymclevel import TAG_String
from pymclevel import TAG_Compound

displayName = "Speech Bubbles"

inputs = (
    ("Text:", ("string", "value=Text")),
    ("Particles:", ("dripWater", "dripLava")),
    ("Display at:", ("string", "value=@p")),
    ("Distance to Entity:", 2),
    ("Direction:", ("-X -> +X", "+X -> -X", "-Z -> +Z", "+Z -> -Z")),
    ("For information about Emoticons and custom Symbols visit <url>", "label")
)


def perform(level, box, options):
    global GlobalLevel
    GlobalLevel = level

    text = options["Text:"]
    particleType = options["Particles:"]
    entitySelector = options["Display at:"]
    dy = options["Distance to Entity:"]
    direction = options["Direction:"]

    characters = {
        "A": PGroup([(0, 0), (0, 0.1), (0, 0.2), (0, 0.3), (0.1, 0.2), (0.1, 0.4), (0.2, 0.2), (0.2, 0.4), (0.3, 0), (0.3, 0.1), (0.3, 0.2), (0.3, 0.3)], 0.4, 0.5),
        "B": PGroup([(0, 0), (0, 0.1), (0, 0.2), (0, 0.3), (0, 0.4), (0.1, 0), (0.1, 0.2), (0.1, 0.4), (0.2, 0), (0.2, 0.2), (0.2, 0.4), (0.3, 0.1), (0.3, 0.3)], 0.4, 0.5),
        "C": PGroup([(0, 0.1), (0, 0.2), (0, 0.3), (0.1, 0), (0.1, 0.4), (0.2, 0), (0.2, 0.4)], 0.3, 0.5),
        "D": PGroup([(0, 0), (0, 0.1), (0, 0.2), (0, 0.3), (0, 0.4), (0.1, 0), (0.1, 0.4), (0.2, 0), (0.2, 0.4), (0.3, 0.1), (0.3, 0.1), (0.3, 0.3)], 0.4, 0.5),
        "E": PGroup([(0, 0), (0, 0.1), (0, 0.2), (0, 0.3), (0, 0.4), (0.1, 0), (0.1, 0.2), (0.1, 0.4), (0.2, 0), (0.2, 0.2), (0.2, 0.4)], 0.3, 0.5),
        "F": PGroup([(0, 0), (0, 0.1), (0, 0.2), (0, 0.3), (0, 0.4), (0.1, 0.2), (0.1, 0.4), (0.2, 0.2), (0.2, 0.4)], 0.3, 0.5),
        "G": PGroup([(0, 0.1), (0, 0.2), (0, 0.3), (0.1, 0), (0.1, 0.4), (0.2, 0), (0.2, 0.1), (0.2, 0.4)], 0.3, 0.5),
        "H": PGroup([(0, 0), (0, 0.1), (0, 0.2), (0, 0.3), (0, 0.4), (0.1, 0.2), (0.2, 0.2), (0.3, 0), (0.3, 0.1), (0.3, 0.2), (0.3, 0.3), (0.3, 0.4)], 0.4, 0.5),
        "I": PGroup([(0, 0), (0, 0.4), (0.1, 0), (0.1, 0.1), (0.1, 0.2), (0.1, 0.3), (0.1, 0.4), (0.2, 0), (0.2, 0.4)], 0.3, 0.5),
        "J": PGroup([(0, 0.1), (0, 0.4), (0.1, 0), (0.1, 0.4), (0.2, 0), (0.2, 0.1), (0.2, 0.2), (0.2, 0.3),  (0.2, 0.4)], 0.3, 0.5),
        "K": PGroup([(0, 0.1), (0, 0.2), (0, 0.3), (0, 0.4), (0.1, 0.2), (0.2, 0.1), (0.2, 0.2), (0.3, 0), (0.3, 0.4)], 0.4, 0.5),
        "L": PGroup([(0, 0.1), (0, 0.2), (0, 0.3), (0, 0.4), (0.1, 0), (0.2, 0)], 0.3, 0.5),
        "M": PGroup([(0, 0), (0, 0.1), (0, 0.2), (0, 0.3), (0, 0.4), (0.1, 0.3), (0.2, 0.2), (0.3, 0.3), (0.4, 0), (0.4, 0.1), (0.4, 0.2), (0.4, 0.3), (0.4, 0.4)], 0.5, 0.5),
        "N": PGroup([(0, 0), (0, 0.1), (0, 0.2), (0, 0.3), (0, 0.4), (0.1, 0.3), (0.2, 0.2), (0.3, 0.1), (0.4, 0), (0.4, 0.1), (0.4, 0.2), (0.4, 0.3), (0.4, 0.4)], 0.5, 0.5),
        "O": PGroup([(0, 0.1), (0, 0.2), (0, 0.3), (0.1, 0), (0.1, 0.4), (0.2, 0), (0.2, 0.4), (0.3, 0.1), (0.3, 0.2), (0.3, 0.3)], 0.4, 0.5),
        "P": PGroup([(0, 0), (0, 0.1), (0, 0.2), (0, 0.3), (0, 0.4), (0.1, 0.2), (0.1, 0.4), (0.2, 0.2), (0.2, 0.4), (0.3, 0.3)], 0.4, 0.5),
        "Q": PGroup([(0, 0.1), (0, 0.2), (0, 0.3), (0.1, 0), (0.1, 0.4), (0.2, 0.1), (0.2, 0.4), (0.3, 0), (0.3, 0.2), (0.3, 0.3)], 0.4, 0.5),
        "R": PGroup([(0, 0), (0, 0.1), (0, 0.2), (0, 0.3), (0, 0.4), (0.1, 0.2), (0.1, 0.4), (0.2, 0.2), (0.2, 0.4), (0.3, 0), (0.3, 0.1), (0.3, 0.3)], 0.4, 0.5),
        "S": PGroup([(0, 0), (0, 0.2), (0, 0.3), (0, 0.4), (0.1, 0.1), (0.1, 0.2), (0.1, 0.4), (0.2, 0), (0.2, 0.1), (0.2, 0.2), (0.2, 0.4)], 0.3, 0.5),
        "T": PGroup([(0, 0.4), (0.1, 0), (0.1, 0.1), (0.1, 0.2), (0.1, 0.3), (0.1, 0.4), (0.2, 0.4)], 0.3, 0.5),
        "U": PGroup([(0, 0.1), (0, 0.2), (0, 0.3), (0, 0.4), (0.1, 0), (0.2, 0), (0.3, 0.1), (0.3, 0.2), (0.3, 0.3), (0.3, 0.4)], 0.4, 0.5),
        "V": PGroup([(0, 0.1), (0, 0.3), (0, 0.4), (0.1, 0.1), (0.2, 0), (0.3, 0.1), (0.4, 0.2), (0.4, 0.3), (0.4, 0.4)], 0.5, 0.5),
        "W": PGroup([(0, 0), (0, 0.1), (0, 0.2), (0, 0.3), (0, 0.4), (0.1, 0.1), (0.2, 0.2), (0.3, 0.1), (0.4, 0), (0.4, 0.1), (0.4, 0.2), (0.4, 0.3), (0.4, 0.4)], 0.5, 0.5),
        "X": PGroup([(0, 0), (0, 0.4), (0.1, 0.1), (0.1, 0.3), (0.2, 0.2), (0.3, 0.1), (0.3, 0.3), (0.4, 0), (0.4, 0.4)], 0.5, 0.5),
        "Y": PGroup([(0, 0.4), (0.1, 0.3), (0.2, 0), (0.2, 0.1), (0.2, 0.2), (0.3, 0.3), (0.4, 0.4)], 0.5, 0.5),
        "Z": PGroup([(0, 0), (0, 0.1), (0, 0.4), (0.1, 0), (0.1, 0.2), (0.1, 0.4), (0.2, 0), (0.2, 0.2), (0.2, 0.4), (0.3, 0), (0.3, 0.3), (0.3, 0.4)], 0.4, 0.5),

        "a": PGroup([(0, 0.1), (0.1, 0), (0.1, 0.2), (0.2, 0), (0.2, 0.1), (0.2, 0.2)], 0.3, 0.3),
        "b": PGroup([(0, 0), (0, 0.1), (0, 0.2), (0, 0.3), (0, 0.4), (0.1, 0), (0.1, 0.2), (0.2, 0), (0.2, 0.2), (0.3, 0.1)], 0.4, 0.5),
        "c": PGroup([(0, 0.1), (0.1, 0), (0.1, 0.2), (0.2, 0), (0.2, 0.2)], 0.3, 0.3),
        "d": PGroup([(0, 0.1), (0.1, 0), (0.1, 0.2), (0.2, 0), (0.2, 0.2), (0.3, 0), (0.3, 0.1), (0.3, 0.2), (0.3, 0.3), (0.3, 0.4)], 0.4, 0.5),
        "e": PGroup([(0.1, 0.1), (0.1, 0.2), (0.2, 0), (0.2, 0.1), (0.2, 0.3), (0.3, 0), (0.3, 0.2)], 0.3, 0.4),
        "f": PGroup([(0, -0.2), (0, -0.1), (0, 0), (0, 0.1), (0, 0.2), (0, 0.3), (0, 0.4), (0.1, 0.2), (0.1, 0.4), (0.2, 0.4)], 0.3, 0.5),
        "g": PGroup([(0, 0.1), (0.1, -0.2), (0.1, 0), (0.1, 0.2), (0.2, -0.2), (0.2, -0.1), (0.2, 0), (0.2, 0.1)], 0.3, 0.3),
        "h": PGroup([(0, 0), (0, 0.1), (0, 0.2), (0, 0.3), (0, 0.4), (0.1, 0.2), (0.2, 0.2), (0.3, 0), (0.3, 0.1)], 0.4, 0.5),
        "i": PGroup([(0, 0), (0, 0.1), (0, 0.3)], 0.1, 0.4),
        "j": PGroup([(0, -0.2), (0.1, -0.2), (0.1, -0.1), (0.1, 0), (0.1, 0.1), (0.1, 0.3)], 0.2, 0.4),
        "k": PGroup([(0, 0), (0, 0.1), (0, 0.2), (0, 0.3), (0, 0.4), (0.1, 0.1), (0.2, 0), (0.2, 0.2)], 0.3, 0.5),
        "l": PGroup([(0, 0.1), (0, 0.2), (0, 0.3), (0, 0.4), (0.1, 0)], 0.2, 0.5),
        "m": PGroup([(0, 0), (0, 0.1), (0, 0.2), (0.1, 0.2), (0.2, 0), (0.2, 0.1), (0.3, 0.2), (0.4, 0), (0.4, 0.1)], 0.5, 0.3),
        "n": PGroup([(0, 0), (0, 0.1), (0, 0.2), (0.1, 0.2), (0.2, 0), (0.2, 0.1)], 0.3, 0.3),
        "o": PGroup([(0, 0.1), (0.1, 0), (0.1, 0.2), (0.2, 0.1)], 0.3, 0.3),
        "p": PGroup([(0, -0.2), (0, -0.1), (0, 0), (0, 0.1), (0, 0.2), (0.1, 0), (0.1, 0.2), (0.2, 0.1)], 0.3, 0.3),
        "q": PGroup([(0, 0.1), (0.1, 0), (0.1, 0.2), (0.2, -0.2), (0.2, -0.1), (0.2, 0), (0.2, 0.1), (0.2, 0.2)], 0.3, 0.3),
        "r": PGroup([(0, 0), (0, 0.1), (0, 0.2), (0.1, 0.2)], 0.2, 0.3),
        "s": PGroup([(0, 0), (0.1, 0), (0.1, 0.1), (0.1, 0.2), (0.2, 0.2)], 0.3, 0.3),
        "t": PGroup([(0, 0.2), (0.1, 0), (0.1, 0.1), (0.1, 0.2), (0.1, 0.3), (0.1, 0.4), (0.2, 0.2)], 0.3, 0.5),
        "u": PGroup([(0, 0.1), (0, 0.2), (0.1, 0), (0.2, 0), (0.2, 0.1), (0.2, 0.2)], 0.3, 0.3),
        "v": PGroup([(0, 0.1), (0, 0.2), (0.1, 0), (0.2, 0.1), (0.2, 0.2)], 0.3, 0.3),
        "w": PGroup([(0, 0.1), (0, 0.2), (0.1, 0), (0.2, 0.1), (0.3, 0), (0.4, 0.1), (0.4, 0.2)], 0.5, 0.3),
        "x": PGroup([(0, 0), (0, 0.2), (0.1, 0.1), (0.2, 0), (0.2, 0.2)], 0.3, 0.3),
        "y": PGroup([(0, 0.1), (0, 0.2), (0.1, -0.2), (0.1, 0), (0.2, -0.2), (0.2, -0.1), (0.2, 0), (0.2, 0.1), (0.2, 0.2)], 0.3, 0.3),
        "z": PGroup([(0, 0.2), (0.1, 0), (0.1, 0.1), (0.1, 0.2), (0.2, 0)], 0.3, 0.3),

        "0": PGroup([(0, 0.1), (0, 0.2), (0, 0.3), (0.1, 0), (0.1, 0.4), (0.2, 0), (0.2, 0.2), (0.2, 0.4), (0.3, 0), (0.3, 0.4), (0.4, 0.1), (0.4, 0.2), (0.4, 0.3)], 0.5, 0.5),
        "1": PGroup([(0, 0), (0, 0.3), (0, 0.4), (0.1, 0), (0.1, 0.1), (0.1, 0.2), (0.1, 0.3), (0.1, 0.4), (0.2, 0), (0.2, 0.4)], 0.3, 0.5),
        "2": PGroup([(0, 0), (0, 0.1), (0, 0.4), (0.1, 0), (0.1, 0.2), (0.1, 0.4), (0.2, 0), (0.2, 0.2), (0.2, 0.3)], 0.3, 0.5),
        "3": PGroup([(0, 0), (0, 0.2), (0, 0.4), (0.1, 0), (0.1, 0.2), (0.1, 0.4), (0.2, 0.1), (0.2, 0.3)], 0.3, 0.5),
        "4": PGroup([(0, 0.2), (0.1, 0.1), (0.1, 0.3), (0.2, 0.1), (0.2, 0.4), (0.3, 0), (0.3, 0.1), (0.3, 0.2), (0.3, 0.3)], 0.4, 0.5),
        "5": PGroup([(0, 0), (0, 0.2), (0, 0.3), (0, 0.4), (0.1, 0), (0.1, 0.2), (0.1, 0.4), (0.2, 0.1), (0.2, 0.4)], 0.3, 0.5),
        "6": PGroup([(0, 0.1), (0, 0.2), (0, 0.3), (0.1, 0), (0.1, 0.2), (0.1, 0.4), (0.2, 0), (0.2, 0.2), (0.2, 0.4), (0.3, 0.1)], 0.4, 0.5),
        "7": PGroup([(0, 0), (0, 0.1), (0, 0.4), (0.1, 0.2), (0.1, 0.4), (0.2, 0.3), (0.2, 0.4)], 0.3, 0.5),
        "8": PGroup([(0, 0.1), (0, 0.3), (0.1, 0), (0.1, 0.2), (0.1, 0.4), (0.2, 0), (0.2, 0.2), (0.2, 0.4), (0.3, 0.1), (0.3, 0.3)], 0.4, 0.5),
        "9": PGroup([(0, 0.3), (0.1, 0), (0.1, 0.2), (0.1, 0.4), (0.2, 0), (0.2, 0.2), (0.2, 0.4), (0.3, 0.1), (0.3, 0.2), (0.3, 0.3)], 0.4, 0.5),

        ".": PGroup([(0, 0)], 0.1, 0.1),
        ",": PGroup([(0, -0.1), (0, 0)], 0.1, 0.1),
        ":": PGroup([(0, 0), (0, 0.2)], 0.1, 0.3),
        "!": PGroup([(0, 0), (0, 0.2), (0, 0.3), (0, 0.4)], 0.1, 0.3),
        "?": PGroup([(0, 0.4), (0.1, 0), (0.1, 0.2), (0.1, 0.4), (0.2, 0.2), (0.2, 0.3), (0.2, 0.4)], 0.3, 0.5),

        "_": PGroup([(0, 0), (0.1, 0), (0.2, 0)], 0.3, 0.1)
    }

    customSymbols = {
        ":)": PGroup([(0, 0.1), (0.1, 0), (0.1, 0.4), (0.2, 0), (0.3, 0), (0.4, 0), (0.4, 0.4), (0.5, 0.1)], 0.6, 0.5),
        ":(": PGroup([(0, 0), (0.1, 0.1), (0.1, 0.4), (0.2, 0.1), (0.3, 0.1), (0.4, 0.1), (0.4, 0.4), (0.5, 0)], 0.6, 0.5),
        ":|": PGroup([(0, 0.1), (0.1, 0.1), (0.1, 0.4), (0.2, 0.1), (0.3, 0.1), (0.4, 0.1), (0.4, 0.4), (0.5, 0.1)], 0.6, 0.5),
        ":D": PGroup([(0, 0.1), (0, 0.2), (0.1, 0), (0.1, 0.4), (0.2, 0), (0.3, 0), (0.4, 0), (0.4, 0.4), (0.5, 0.1), (0.5, 0.2)], 0.6, 0.5),
        ";)": PGroup([(0, 0.1), (0.1, 0), (0.1, 0.4), (0.2, 0), (0.2, 0.4), (0.3, 0), (0.4, 0), (0.4, 0.4), (0.5, 0.1)], 0.6, 0.5),
    }

    width = 0.0
    word = ""
    particles = []

    i = 0
    for letter in text:
        if letter == " ":
            width += 0.4

            try:
                pGroupSymbol = customSymbols[word]
                for particle in pGroupSymbol.particles:
                    particles.append((particle[0] + width, particle[1]))
                width += pGroupSymbol.totalWidth

            except:
                pass

            word = ""

        try:
            pGroupCharacter = characters[letter]
            for particle in pGroupCharacter.particles:
                particles.append((particle[0] + width, particle[1]))
            width += pGroupCharacter.totalWidth

        except:
            pGroupUnknown = characters["_"]
            for particle in pGroupUnknown.particles:
                particles.append((particle[0] + width, particle[1]))
            width += pGroupUnknown.totalWidth

        width += 0.1
        i += 1

    lastSpaceLocation = 0
    while text[lastSpaceLocation+1:].find(" ") > -1:
        lastSpaceLocation = text[lastSpaceLocation+1:].find(" ")

    try:
        pGroupSymbol = customSymbols[text[lastSpaceLocation+1:]]
        for particle in pGroupSymbol.particles:
            particles.append((particle[0] + width, particle[1]))
        width += pGroupSymbol.totalWidth

    except:
        pass

    commands = []
    textStart = 0.0 - width/2

    for particlePosition in particles:
        if direction == "-X -> +X":
            command = "/particle " + particleType + " ~" + str(textStart + particlePosition[0]) + " ~" + str(dy + particlePosition[1]) + " ~ 0 0 0 0 10 " + entitySelector

        elif direction == "+X -> -X":
            command = "/particle " + particleType + " ~" + str(-1*(textStart + particlePosition[0])) + " ~" + str(dy + particlePosition[1]) + " ~ 0 0 0 0 10 " + entitySelector

        elif direction == "-Z -> +Z":
            command = "/particle " + particleType + " ~ ~" + str(dy + particlePosition[1]) + " ~" + str(textStart + particlePosition[0]) + " 0 0 0 0 10 " + entitySelector

        elif direction == "+Z -> -Z":
            command = "/particle " + particleType + " ~ ~" + str(dy + particlePosition[1]) + " ~" + str(-1*(textStart + particlePosition[0])) + " 0 0 0 0 10 " + entitySelector

        commands.append(command)

    if len(commands) > 15:
        totalZ = 15
        totalX = int(len(commands)/15) + 1
    else:
        totalZ = len(commands)
        totalX = 1

    schematic = MCSchematic((totalX, 2, totalZ))

    x = 0
    z = 0
    for command in commands:
        schematic.TileEntities.append(AddCommandBlock(schematic, x, 0, z, command))
        schematic.setBlockAt(x, 0, z, 137)
        schematic.setBlockAt(x, 1, z, 55)

        if z < 14:
            z += 1
        else:
            x += 1
            z = 0

    schematicFile = mcplatform.askSaveFile(mcplatform.lastSchematicsDir or mcplatform.schematicsDir, "Save Schematic As...", "", "Schematic\0*.schematic\0\0", ".schematic")
    schematic.saveToFile(schematicFile)


class PGroup:
    def __init__(self, particles, totalWidth, totalHeigth):
        self.particles = particles
        self.totalWidth = totalWidth


def AddCommandBlock(schematic, x, y, z, command):
    control = TAG_Compound()
    control["Command"] = TAG_String(command)
    control["id"] = TAG_String(u'Control')
    control["CustomName"] = TAG_String(u'@')
    control["SuccessCount"] = TAG_Int(0)
    control["x"] = TAG_Int(x)
    control["y"] = TAG_Int(y)
    control["z"] = TAG_Int(z)
    return control
